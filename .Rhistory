getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=F, numCores = 2, minPenalty = 0, maxPenalty = 10000)
series <- simSeries
minPenalty=0
maxPenalty = 100000
#Run CROPS on PELT to detect changepoints based on changes in mean.
#capture.output prevents progress messages that are printed by running CROPS.
capture.output(results <- cpt.mean(series, penalty="CROPS", pen.value=c(minPenalty, maxPenalty), method="PELT", test.stat="Normal", class=F, minseglen=1)$changepoints)
pValue <- 0
#Start at end of "results", corresponding to no changepoints. Iterate backwards, including more changepoints.
maxIndex <- length(results)
if(maxIndex == 1){
stop("Only one set of changepoints found. Please try decreasing minPenalty towards 0 and/or increasing maxPenalty.")
}
maxIndex
results
maxPenalty = 10e12
#Run CROPS on PELT to detect changepoints based on changes in mean.
#capture.output prevents progress messages that are printed by running CROPS.
capture.output(results <- cpt.mean(series, penalty="CROPS", pen.value=c(minPenalty, maxPenalty), method="PELT", test.stat="Normal", class=F, minseglen=1)$changepoints)
results
pValue <- 0
#Start at end of "results", corresponding to no changepoints. Iterate backwards, including more changepoints.
maxIndex <- length(results)
if(maxIndex == 1){
stop("Only one set of changepoints found. Please try decreasing minPenalty towards 0 and/or increasing maxPenalty.")
}
index <- maxIndex
maxIndex
index
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
numTrials=5000
serial=T
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
pValue
index <- index - 1
index
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
verbose=T
alpha=0.01
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
index <- index - 1
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
index <- index - 1
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
index <- index - 1
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
index <- index - 1
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
index <- index - 1
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
index <- index - 1
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
index <- index - 1
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
index <- index - 1
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
index <- index - 1
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
index <- index - 1
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
index <- index - 1
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
results[[index - 1]]
index
index <- 585
pValue <- getPValue(series, changepoints1 = results[[index]], changepoints2 = results[[index - 1]], numTrials, serial=serial)
pValue
results[[index]]
index <- index - 1
if(verbose){
if(pValue < alpha){
if(pValue == 0){
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value below:", 1/numTrials))
}
else{
message(paste("Changepoint set", maxIndex - index, "significant with empirical p-value:", pValue))
}
}
else{
message(paste("Changepoint set", maxIndex - index, "insignificant with empirical p-value:", pValue))
}
}
results[[index+1]]
library(changepointSelect)
simChangepointsTrimmed <- trimChangepoints(series=simSeries, changepoints=simChangepoints, thresholdLinear=1.2, thresholdSeasonal=1.2)
simChangepoints
library(changepointSelect)
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=F, numCores = 2)
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=F, numCores = 2, verbose=F)
getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=F, numCores = 2, maxPenalty = 10000)
simChangepointsTrimmed <- trimChangepoints(series=simSeries, changepoints=simChangepoints, thresholdLinear=1.2, thresholdSeasonal=1.2, verbose=T)
simChangepointsTrimmed <- trimChangepoints(series=simSeries, changepoints=simChangepoints, thresholdLinear=1.2, thresholdSeasonal=1, verbose=T)
simChangepointsTrimmed <- trimChangepoints(series=simSeries, changepoints=simChangepoints, thresholdLinear=1, thresholdSeasonal=1.2, verbose=T)
simChangepointsTrimmed <- trimChangepoints(series=simSeries, changepoints=simChangepoints, thresholdLinear=1.2, thresholdSeasonal=1.2, verbose=F)
simChangepointsTrimmed <- trimChangepoints(series=simSeries, changepoints=simChangepoints, thresholdLinear=1.2, thresholdSeasonal=1, verbose=F)
simChangepointsTrimmed <- trimChangepoints(series=simSeries, changepoints=simChangepoints, thresholdLinear=1, thresholdSeasonal=1.2, verbose=F)
simChangepointsTrimmed
?getChangepoints
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=F, numCores = 2, verbose=F, minPenalty = 1000, maxPenalty = 2000)
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=F, numCores = 2, verbose=F, minPenalty = 1900, maxPenalty = 2000)
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=F, numCores = 2, verbose=F, minPenalty = 9000, maxPenalty = 10000)
library(changepointSelect)
?getChangepoints
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=F, numCores = 2)
simChangepointsTrimmed <- trimChangepoints(series=simSeries, changepoints=simChangepoints, thresholdLinear=1.2, thresholdSeasonal=1.2)
plot(y=simSeries, x=1:length(simSeries), type="l", ylab="Simulated Value", xlab="Index", main="Simulated Data with Trimmed Changepoints")
abline(v=simChangepointsTrimmed, col="red")
simChangepointsTrimmed
?getChangepoints
?trimChangepoints
library(foreach)
rm(foreach)
detach("package:foreach", unload = TRUE)
library(doParallel)
findTotalSavings <- function(savingsByYear, interestRate=0.07, increaseSavingsRate=0){
totalYears <- length(savingsByYear)
years <- seq(totalYears, 1, by=-1)
#print(years)
#print(savingsByYear*((1+increaseSavingsRate)^(totalYears-years))*(1+interestRate)^years)
return(sum(savingsByYear*((1+increaseSavingsRate)^(totalYears -years))*(1+interestRate)^years))
}
savings <- rep(18000, 20)
findTotalSavings(savings)
findTotalSavings(savingsByYear = c(18000))
savings <- rep(50000, 20)
findTotalSavings(savings, interestRate=0.05, increaseSavingsRate = 0.02)
savings <- c(rep(50000, 10), rep(75000, 5), rep(100000, 5), rep(125000, 5))
findTotalSavings(savings, interestRate=0.05, increaseSavingsRate = 0.00)
savings <- rep(100000, 20)
findTotalSavings(savings, interestRate=0.05, increaseSavingsRate = 0.02)
findTotalSavings(savings, interestRate=0.10, increaseSavingsRate = 0.02)
savings <- rep(100000, 30)
findTotalSavings(savings, interestRate=0.10, increaseSavingsRate = 0.02)
temp <- c(1,1,1,1,1)
sd(temp)
library(changepointSelect)
simSeries
system.time({
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=F, numCores = 2)
})
system.time({
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=T)
})
system.time({
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=25000, serial=F, numCores = 2)
})
system.time({
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=50000, serial=F, numCores = 2)
})
2e-05
1/50000
system.time({
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=50000, serial=T)
})
system.time({
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=50000, serial=T)
})
system.time({
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=50000, serial=F, numCores = 6)
})
profvis::profvis({  simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=50000, serial=F, numCores = 6)})
?getPValue
profvis::profvis({getPValue(series=simSeries, changepoints1=c(49, 60), changepoints2 = c(49,60,600), numTrials=50000, serial=T)})
sd(c(1))
sdsVec <- c(1,2,3,NA,5,6,7,NA,9,10)
#Get the logLikelihood of the entire series, ignoring segments that only have one observation (i.e. sd is NA)
moreThanOne <- which(!is.na(sdsVec) & sdsVec != 0)
moreThanOne
sdsVec[moreThanOne]
#Get the logLikelihood of the entire series, ignoring segments that only have one observation (i.e. sd is NA)
moreThanOne <- (!is.na(sdsVec) & sdsVec != 0)
sdsVec[moreThanOne]
temp <- rnorm(100)
temp <- rnorm(100)
system.time({
for(i in 1:50000){
mean(temp)
}
})
temp <- rnorm(1000)
system.time({
for(i in 1:500000){
mean(temp)
}
})
system.time({
for(i in 1:500000){
sum(temp)/length(temp)
}
})
system.time({
for(i in 1:500000){
sum(temp)/length(temp)
}
})
temp <- rnorm(1000)
system.time({
for(i in 1:1000000){
mean(temp)
}
})
system.time({
for(i in 1:1000000){
sum(temp)/length(temp)
}
})
?sum
?length
system.time({
for(i in 1:1000000){
mean(temp, na.rm=T)
}
})
system.time({
for(i in 1:1000000){
sum(temp, na.rm=T)/sum(!is.na(temp))
}
})
temp
sd(temp)
sqrt(mean((temp - mean(temp))^2))
sqrt((1/(length(temp)-1))*((temp - mean(temp))^2))
sqrt((1/(length(temp)-1))*sum((temp - mean(temp))^2))
sd(temp)
temp
changepoints <- c(100, 200)
i = i
subSeries <- series[(changepoints[i]+1):changepoints[i+1]]
series <- temp
subSeries <- series[(changepoints[i]+1):changepoints[i+1]]
changepoints
i
i = 1
subSeries <- series[(changepoints[i]+1):changepoints[i+1]]
subSeries
changepoints[i+1] - changepoints[i]
length(subSeries)
mean(subSeries)
segLengths <- rep(NA, 2)
segLengths[i] <- changepoints[i+1] - changepoints[i]
means <- rep(NA, 2)
sds <- rep(NA,2)
segLengths[i] <- changepoints[i+1] - changepoints[i]
means[i] <- sum(subSeries)/segLengths[i] #mean(subSeries)
sds[i] <- sqrt((1/(segLengths[i]-1))*sum((subSeries - means[i])^2)) #sd(subSeries)
segLengths[i]
length(subSeries)
means[i]
mean(subSeries)
sds[i]
sd(subSeries)
vars <- rep(NA, 2)
vars[i] <- (1/(segLengths[i]-1))*sum((subSeries - means[i])^2) #var(subSeries)
vars[i]
var(subSeries)
i = 2
subSeries <- series[(changepoints[i]+1):changepoints[i+1]]
segLengths[i] <- changepoints[i+1] - changepoints[i]
changepoints
changepoints <- c(0, 100, 200, length(series))
changepoints
#The mean() and sd() functions are avoided to reduce runtime by not performing error checks.
#They are therefore written out manually below.
for(i in 1:(length(changepoints)-1)){
subSeries <- series[(changepoints[i]+1):changepoints[i+1]]
segLengths[i] <- changepoints[i+1] - changepoints[i]
means[i] <- sum(subSeries)/segLengths[i] #mean(subSeries)
sds[i] <- sqrt((1/(segLengths[i]-1))*sum((subSeries - means[i])^2)) #sd(subSeries)
}
segLengths
means
sds
i = 1
subSeries <- series[(changepoints[i]+1):changepoints[i+1]]
mean(subSeries)
sds(subSeries)
sd(subSeries)
i = 2
subSeries <- series[(changepoints[i]+1):changepoints[i+1]]
means[i] <- sum(subSeries)/segLengths[i] #mean(subSeries)
means
mean(subSeries)
sd(subSeries)
i = 3
mean(subSeries)
sd(subSeries)
subSeries <- series[(changepoints[i]+1):changepoints[i+1]]
mean(subSeries)
sd(subSeries)
means
sds
#Prepare means and sds by obs
meansVec <- rep(means, times=segLengths)
sdsVec <- rep(sds, times=segLengths)
meansVec
sdsVec
#Get the logLikelihood of the entire series, ignoring segments that only have one observation (i.e. sd is NA) or are constant (i.e. sd = 0).
moreThanOne <- (!is.na(sdsVec) & sdsVec != 0)
moreThanOne
sdsVec[moreThanOne]
sdsVec
sum(dnorm(series[moreThanOne], mean=meansVec[moreThanOne], sd=sdsVec[moreThanOne], log=T))
-(n/2)*ln(2*pi) - (n/2)*ln(sdsVec[moreThanOne]^2) - (1/(2*sdsVec[moreThanOne]^2))*sum(subSeries - means[moreThanOne])
sum(-(1/2)*ln(2*pi) - (1/2)*ln(sdsVec[moreThanOne]^2) - (1/(2*sdsVec[moreThanOne]^2))*(subSeries - means[moreThanOne]))
sum(-(1/2)*log(2*pi) - (1/2)*log(sdsVec[moreThanOne]^2) - (1/(2*sdsVec[moreThanOne]^2))*(subSeries - means[moreThanOne]))
sum(-(1/2)*log(2*pi) - (1/2)*log(sdsVec[moreThanOne]^2) - (1/(2*sdsVec[moreThanOne]^2))*(subSeries[moreThanOne] - meansVec[moreThanOne]))
subSeries
-(1/2)*log(2*pi) - (1/2)*log(sdsVec[moreThanOne]^2) - (1/(2*sdsVec[moreThanOne]^2))*(subSeries[moreThanOne] - meansVec[moreThanOne])
meansVec
sdsVec
sum(-(1/2)*log(2*pi) - (1/2)*log(sdsVec[moreThanOne]^2) - (1/(2*sdsVec[moreThanOne]^2))*(series[moreThanOne] - meansVec[moreThanOne]))
sum(dnorm(series[moreThanOne], mean=meansVec[moreThanOne], sd=sdsVec[moreThanOne], log=T))
sum(-(1/2)*log(2*pi) - (1/2)*log(sdsVec[moreThanOne]^2) - (1/(2*sdsVec[moreThanOne]^2))*((series[moreThanOne] - meansVec[moreThanOne])^2))
library(changepointSelect)
library(changepointSelect)
simSeries
rm(list=ls())
library(changepointSelect)
system.time({ #329 seconds
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=50000, serial=F, numCores = 2)
})
198/329
system.time({ #337 seconds before modifications on mean(), sd(), dnorm()
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=50000, serial=T)
})
144/337
system.time({ #247 seconds before modifications on mean(), sd(), dnorm()
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=50000, serial=F, numCores = 6)
})
profvis::profvis({getChangepoints(series=simSeries, alpha=0.01, numTrials=50000, serial=T)})
simChangepoints
144/12
system.time({
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=T)
})
30/45
system.time({
simChangepoints <- getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=F, numCores = 2)
})
profvis::profvis({getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=T)})
library(changepointSelect)
profvis::profvis({ getChangepoints(series=simSeries, alpha=0.01, numTrials=10000, serial=T)})
library(changepointSelect)
getChangepoints(series=c(simSeries, NA, 150), alpha=0.01, numTrials=10000, serial=T)
library(changepointSelect)
